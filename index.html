<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SalsaChat</title>
<meta name="theme-color" content="#10b981">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
*{box-sizing:border-box;font-family:system-ui;margin:0;padding:0}
body{background:#000;display:flex;justify-content:center;height:100vh}
.app{width:100%;max-width:430px;height:100%;background:#fff;display:flex;flex-direction:column}

/* REGISTER */
.register{flex:1;display:flex;flex-direction:column;justify-content:center;padding:20px}
.register h2{text-align:center;margin-bottom:20px}
.register input,.register select{padding:12px;margin:8px 0;border-radius:12px;border:1px solid #ccc}
.register button{padding:12px;border:none;border-radius:20px;background:#10b981;color:#fff;font-weight:bold}

/* HEADER */
.header{background:linear-gradient(135deg,#10b981,#34d399);padding:10px;color:#fff;display:flex;align-items:center;gap:10px}
.header img{width:42px;height:42px;border-radius:50%;border:2px solid #fff}
.header .info{flex:1}
.edit{font-size:18px;cursor:pointer}

/* CHAT */
.chat{flex:1;display:flex;flex-direction:column}
.messages{flex:1;overflow-y:auto;padding:10px;background:#f0f2f5}

/* BUBBLE */
.msg{max-width:75%;margin:6px;padding:10px 14px;border-radius:18px;font-size:14px}
.me{background:#10b981;color:#fff;margin-left:auto}
.other{background:#e5e7eb;color:#000;margin-right:auto}
.sender{font-size:11px;font-weight:bold;margin-bottom:4px;opacity:.7}
.time{font-size:10px;opacity:.6;text-align:right;margin-top:4px}
.msg img,audio{max-width:200px;border-radius:12px;margin-top:5px}

/* INPUT */
.input{display:flex;align-items:center;padding:6px;border-top:1px solid #ddd}
.input input{flex:1;padding:10px;border-radius:20px;border:1px solid #ccc}
.icon{font-size:20px;margin:0 6px;cursor:pointer}
.send{background:#10b981;color:#fff;border:none;border-radius:20px;padding:10px 14px}

/* PROFIL */
.profil{position:fixed;inset:0;background:#fff;display:none;flex-direction:column;padding:20px}
.avatar{width:120px;height:120px;margin:20px auto;border-radius:50%;overflow:hidden;border:3px solid #10b981}
.avatar img{width:100%;height:100%;object-fit:cover}
.profil input{padding:12px;margin:8px 0;border-radius:12px;border:1px solid #ccc}
.btn{padding:12px;border:none;border-radius:20px;background:#10b981;color:#fff;font-weight:bold;margin-top:10px}
.danger{background:#ef4444}
</style>
</head>

<body>
<div class="app">

<!-- REGISTER -->
<div class="register" id="register">
  <h2>SalsaChat</h2>
  <input id="regName" placeholder="Nama">
  <select id="country">
    <option value="+62">ğŸ‡®ğŸ‡© Indonesia (+62)</option>
    <option value="+60">ğŸ‡²ğŸ‡¾ Malaysia (+60)</option>
    <option value="+65">ğŸ‡¸ğŸ‡¬ Singapura (+65)</option>
  </select>
  <input id="regPhone" placeholder="Nomor HP">
  <button onclick="registerUser()">Daftar</button>
</div>

<!-- CHAT -->
<div class="chat" id="chat" style="display:none">
  <div class="header">
    <img id="headerAvatar">
    <div class="info">
      <b id="headerName"></b><br>
      <small>ğŸŸ¢ Online</small>
    </div>
    <div class="edit" onclick="openProfile()">âš™ï¸</div>
  </div>

  <div class="messages" id="messages"></div>

  <div class="input">
    <span class="icon" onclick="addEmoji()">ğŸ˜€</span>
    <span class="icon" onclick="imgInput.click()">ğŸ“·</span>
    <span class="icon" onclick="recordVoice()">ğŸ¤</span>
    <input id="text" placeholder="Ketik pesan...">
    <button class="send" onclick="send()">â¤</button>
  </div>
</div>

<!-- PROFIL -->
<div class="profil" id="profil">
  <h3>Edit Profil</h3>
  <div class="avatar"><img id="avatarImg"></div>
  <input type="file" id="avatarInput" accept="image/*" hidden>
  <button class="btn" onclick="avatarInput.click()">Ganti Foto</button>
  <input id="nameInput" placeholder="Nama">
  <input id="phoneInput" placeholder="Nomor HP">
  <button class="btn" onclick="saveProfile()">Simpan</button>
  <button class="btn danger" onclick="resetAccount()">Daftar Nomor Baru</button>
  <button class="btn" onclick="backChat()">â¬… Kembali</button>
</div>

<input type="file" id="imgInput" accept="image/*" hidden>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyCz3EEdbo2DIHFMlmsAVmPwCRWCAqMuxHw",
  databaseURL:"https://salsachat-3a8a1-default-rtdb.firebaseio.com"
});
const db=firebase.database().ref("room/global");

/* STATE */
let name=localStorage.getItem("name");
let phone=localStorage.getItem("phone");
let avatar=localStorage.getItem("avatar")||"https://i.pravatar.cc/150";
if(name&&phone) openChat();

/* REGISTER */
function registerUser(){
  name=regName.value;
  phone=country.value+regPhone.value;
  if(!name||!regPhone.value) return alert("Lengkapi data");
  localStorage.setItem("name",name);
  localStorage.setItem("phone",phone);
  openChat();
}

/* CHAT */
function openChat(){
  register.style.display="none";
  chat.style.display="flex";
  loadProfile();
}
function send(){
  if(!text.value) return;
  db.push({name,msg:text.value,time:new Date().toLocaleTimeString()});
  text.value="";
}
db.on("child_added",s=>{
  const d=s.val();
  messages.innerHTML+=`
  <div class="msg ${d.name===name?'me':'other'}">
    ${d.name!==name?`<div class="sender">${d.name}</div>`:''}
    ${d.msg}
    <div class="time">${d.time}</div>
  </div>`;
  messages.scrollTop=messages.scrollHeight;
});

/* VOICE */
let mediaRecorder,audioChunks=[];
function recordVoice(){
  navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
    mediaRecorder=new MediaRecorder(stream);
    audioChunks=[];
    mediaRecorder.start();
    mediaRecorder.ondataavailable=e=>audioChunks.push(e.data);
    mediaRecorder.onstop=()=>{
      const blob=new Blob(audioChunks,{type:"audio/webm"});
      const r=new FileReader();
      r.onload=()=>db.push({name,msg:`<audio controls src="${r.result}"></audio>`,time:new Date().toLocaleTimeString()});
      r.readAsDataURL(blob);
    };
    setTimeout(()=>mediaRecorder.stop(),5000);
  });
}

/* PROFIL */
function openProfile(){profil.style.display="flex";chat.style.display="none";nameInput.value=name;phoneInput.value=phone}
function backChat(){profil.style.display="none";chat.style.display="flex"}
function saveProfile(){name=nameInput.value;phone=phoneInput.value;localStorage.setItem("name",name);localStorage.setItem("phone",phone);loadProfile();backChat()}
function resetAccount(){localStorage.clear();location.reload()}
function loadProfile(){headerName.innerText=name;headerAvatar.src=avatar;avatarImg.src=avatar}
avatarInput.onchange=e=>{const r=new FileReader();r.onload=()=>{avatar=r.result;localStorage.setItem("avatar",avatar);loadProfile()};r.readAsDataURL(e.target.files[0])}

/* EXTRA */
function addEmoji(){text.value+="ğŸ˜€"}
imgInput.onchange=e=>{const r=new FileReader();r.onload=()=>db.push({name,msg:`<img src="${r.result}">`,time:new Date().toLocaleTimeString()});r.readAsDataURL(e.target.files[0])}
</script>
</body>
</html>