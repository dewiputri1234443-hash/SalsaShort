<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>SalsaChat</title>
<meta name="theme-color" content="#075e54">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
*{box-sizing:border-box;font-family:system-ui;margin:0;padding:0}
body{background:#0b141a;display:flex;justify-content:center;height:100vh;overflow:hidden}
.app{width:100%;max-width:430px;height:100%;background:#efeae2;display:flex;flex-direction:column}

/* REGISTER */
.register{flex:1;display:flex;flex-direction:column;justify-content:center;padding:20px}
.register h2{text-align:center;color:#075e54;margin-bottom:20px}
.register input,.register select{padding:12px;margin:8px 0;border-radius:10px;border:1px solid #ccc}
.register button{padding:12px;border:none;border-radius:25px;background:#25d366;color:#fff;font-weight:bold;margin-top:10px}
.register .secondary{background:#128c7e}

/* HEADER */
.header{background:#075e54;padding:10px;color:#fff;display:flex;align-items:center;gap:10px}
.header img{width:40px;height:40px;border-radius:50%}
.header .info{flex:1}
.icon-btn{font-size:20px;cursor:pointer}

/* CHAT */
.chat{flex:1;display:flex;flex-direction:column}
.messages{flex:1;overflow-y:auto;padding:10px;background:#efeae2}
.msg{max-width:78%;margin:6px 0;padding:8px 12px;border-radius:8px;font-size:14px}
.me{background:#d9fdd3;margin-left:auto}
.other{background:#fff;margin-right:auto}
.sender{font-size:11px;font-weight:bold;color:#075e54;margin-bottom:2px}
.time{font-size:10px;opacity:.6;text-align:right}

.input{display:flex;align-items:center;padding:6px;background:#f0f2f5}
.input input{flex:1;padding:10px 14px;border-radius:20px;border:none;outline:none}
.icon{font-size:22px;margin:0 6px;cursor:pointer}
.send{background:#25d366;color:#fff;border:none;border-radius:50%;width:42px;height:42px}

/* PAGE UMUM */
.page{
  position:absolute;
  inset:0;
  background:#f0f2f5;
  display:none;
  flex-direction:column;
  padding:16px;
}

/* ===== EDIT PROFIL (FIX ONLY) ===== */
#profile{
  background:#f0f2f5;
}
#profile h3{
  text-align:center;
  color:#075e54;
  margin-bottom:16px;
}
#profile .avatar{
  width:90px;
  height:90px;
  margin:16px auto;
}
#profile input{
  width:100%;
  max-width:360px;
  margin:10px auto;
  padding:12px 14px;
  border-radius:12px;
  border:1px solid #ccc;
  font-size:14px;
}
#profile .btn{
  width:100%;
  max-width:360px;
  margin:10px auto;
  padding:12px;
  border-radius:25px;
  font-size:15px;
}

/* Avatar */
.avatar{border-radius:50%;overflow:hidden;border:2px solid #25d366}
.avatar img{width:100%;height:100%;object-fit:cover}

/* PRIVASI */
.privacy-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px;
  border-bottom:1px solid #eee;
  font-size:14px;
}
.privacy-item select{
  border:none;
  background:none;
  font-size:14px;
  outline:none;
}
.switch{position:relative;width:42px;height:22px}
.switch input{display:none}
.slider{position:absolute;inset:0;background:#ccc;border-radius:20px}
.slider:before{
  content:"";
  position:absolute;
  width:18px;height:18px;
  left:2px;top:2px;
  background:#fff;border-radius:50%;
  transition:.3s
}
.switch input:checked + .slider{background:#25d366}
.switch input:checked + .slider:before{transform:translateX(20px)}
</style>
</head>

<body>
<div class="app">

<!-- REGISTER -->
<div class="register" id="register">
  <h2 id="regTitle">SalsaChat</h2>
  <input id="regName" placeholder="Nama">
  <input id="regPhone" placeholder="Nomor HP (tanpa +62)">
  <select id="regCountry">
    <option value="">Pilih Negara</option>
    <option value="+62|Indonesia">ğŸ‡®ğŸ‡© Indonesia (+62)</option>
    <option value="+60|Malaysia">ğŸ‡²ğŸ‡¾ Malaysia (+60)</option>
    <option value="+65|Singapura">ğŸ‡¸ğŸ‡¬ Singapura (+65)</option>
    <option value="+66|Thailand">ğŸ‡¹ğŸ‡­ Thailand (+66)</option>
  </select>
  <button onclick="registerUser()">Daftar</button>
  <button id="btnLogin" class="secondary" onclick="openChat()" style="display:none">
    Lanjut ke Chat
  </button>
</div>

<!-- CHAT -->
<div class="chat" id="chat" style="display:none">
  <div class="header">
    <img id="headerAvatar">
    <div class="info">
      <b id="headerName"></b><br>
      <small id="headerCountry"></small>
    </div>
    <span class="icon-btn" onclick="openContacts()">ğŸ‘¥</span>
    <span class="icon-btn" onclick="openProfile()">âš™ï¸</span>
    <span class="icon-btn" onclick="openPrivacy()">ğŸ”’</span>
    <span class="icon-btn" onclick="callPhone()">ğŸ“</span>
    <span class="icon-btn" onclick="openCamera()">ğŸ¥</span>
  </div>

  <div class="messages" id="messages"></div>

  <div class="input">
    <span class="icon" onclick="addEmoji()">ğŸ˜€</span>
    <span class="icon" onclick="shareLocation()">ğŸ“</span>
    <span class="icon" onclick="imgInput.click()">ğŸ“·</span>
    <span class="icon" onclick="recordVoice()">ğŸ¤</span>
    <input id="text" placeholder="Ketik pesan...">
    <button class="send" onclick="send()">â¤</button>
  </div>
</div>

<!-- KONTAK -->
<div class="page" id="contacts">
  <h3>Kontak</h3>
  <p>ğŸ‘¤ Global Room</p>
  <button class="btn" onclick="backChat()">â¬… Kembali</button>
</div>

<!-- PROFIL -->
<div class="page" id="profile">
  <h3>Edit Profil</h3>
  <div class="avatar"><img id="profileAvatar"></div>
  <input id="profileName" placeholder="Nama">
  <input id="profilePhone" placeholder="Nomor HP">
  <button class="btn" onclick="saveProfile()">Simpan</button>
  <button class="btn" onclick="backChat()">â¬… Kembali</button>
</div>

<!-- PRIVASI -->
<div class="page" id="privacy">
  <h3>Privasi</h3>
  <div class="privacy-item">
    <span>Terakhir Dilihat</span>
    <select><option>Semua Orang</option><option>Kontak Saya</option><option>Tidak Ada</option></select>
  </div>
  <div class="privacy-item">
    <span>Foto Profil</span>
    <select><option>Semua Orang</option><option>Kontak Saya</option><option>Tidak Ada</option></select>
  </div>
  <div class="privacy-item">
    <span>Status</span>
    <select><option>Semua Orang</option><option>Kontak Saya</option><option>Tidak Ada</option></select>
  </div>
  <div class="privacy-item">
    <span>Panggilan</span>
    <label class="switch">
      <input type="checkbox"><span class="slider"></span>
    </label>
  </div>
  <button class="btn" onclick="backChat()">â¬… Kembali</button>
</div>

<input type="file" id="imgInput" hidden>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyCz3EEdbo2DIHFMlmsAVmPwCRWCAqMuxHw",
  databaseURL:"https://salsachat-3a8a1-default-rtdb.firebaseio.com"
});
const db=firebase.database().ref("room/global");

let name=localStorage.getItem("name");
let phone=localStorage.getItem("phone");
let country=localStorage.getItem("country");
let avatar="https://i.pravatar.cc/150";

if(name&&phone){
  btnLogin.style.display="block";
  regTitle.innerText="Selamat Datang di SalsaChat";
}

function registerUser(){
  if(!regName.value||!regPhone.value||!regCountry.value){alert("Lengkapi data");return;}
  name=regName.value.trim();
  const [code,countryName]=regCountry.value.split("|");
  let raw=regPhone.value.replace(/\D/g,"");
  if(raw.startsWith("0")) raw=raw.slice(1);
  phone=code+raw;country=countryName;
  localStorage.setItem("name",name);
  localStorage.setItem("phone",phone);
  localStorage.setItem("country",country);
  openChat();
}
function openChat(){
  register.style.display="none";
  chat.style.display="flex";
  headerName.innerText=name;
  headerCountry.innerText=country+" â€¢ "+phone;
  headerAvatar.src=avatar;
}
function send(){
  if(!text.value) return;
  db.push({name,msg:text.value,time:new Date().toLocaleTimeString()});
  text.value="";
}
db.on("child_added",s=>{
  const d=s.val();
  messages.innerHTML+=`
  <div class="msg ${d.name===name?'me':'other'}">
    ${d.name!==name?`<div class="sender">${d.name}</div>`:''}
    ${d.msg}<div class="time">${d.time}</div>
  </div>`;
  messages.scrollTop=messages.scrollHeight;
});
function openContacts(){chat.style.display="none";contacts.style.display="flex"}
function openProfile(){
  chat.style.display="none";profile.style.display="flex";
  profileName.value=name;profilePhone.value=phone;profileAvatar.src=avatar;
}
function openPrivacy(){chat.style.display="none";privacy.style.display="flex"}
function backChat(){
  contacts.style.display="none";
  profile.style.display="none";
  privacy.style.display="none";
  chat.style.display="flex";
}
function saveProfile(){
  name=profileName.value;phone=profilePhone.value;
  localStorage.setItem("name",name);
  localStorage.setItem("phone",phone);
  headerName.innerText=name;
  headerCountry.innerText=country+" â€¢ "+phone;
  backChat();
}
function callPhone(){location.href="tel:"+phone}
function addEmoji(){text.value+="ğŸ˜€"}
function shareLocation(){
  navigator.geolocation.getCurrentPosition(p=>{
    const link=`https://maps.google.com/?q=${p.coords.latitude},${p.coords.longitude}`;
    db.push({name,msg:`ğŸ“ <a href="${link}" target="_blank">Lihat Lokasi</a>`,time:new Date().toLocaleTimeString()});
  });
}
function openCamera(){
  navigator.mediaDevices.getUserMedia({video:true,audio:true}).then(s=>{
    const v=document.createElement("video");
    v.srcObject=s;v.autoplay=true;
    v.style.position="fixed";v.style.inset="0";v.style.background="#000";
    v.onclick=()=>{s.getTracks().forEach(t=>t.stop());v.remove()}
    document.body.appendChild(v);
  });
}
</script>
</body>
</html>